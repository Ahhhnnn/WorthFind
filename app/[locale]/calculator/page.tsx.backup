"use client";

import { useState, useRef, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { ArrowLeft, TrendingUp, TrendingDown, Minus, Info, LucideIcon, Camera, Check, DollarSign, Clock, TrendingUp as TrendingUpIcon, Smile, Heart } from "lucide-react";
import Link from "next/link";
import html2canvas from "html2canvas";
import { motion, AnimatePresence } from "framer-motion";
import { CollapsibleCard } from "@/components/CollapsibleCard";
import { ScoreDashboard } from "@/components/ScoreDashboard";
import { cn } from "@/lib/utils";

interface FormData {
  // ç»æµå›æŠ¥
  monthlySalary: number;
  annualBonus: number;
  benefits: number;

  // æ—¶é—´æˆæœ¬
  weeklyHours: number;
  commuteHours: number;
  overtimeFrequency: number; // 1-5åˆ†

  // æˆé•¿ä»·å€¼
  skillGrowth: number; // 1-5åˆ†
  promotionChance: number; // 1-5åˆ†
  industryProspect: number; // 1-5åˆ†

  // å·¥ä½œä½“éªŒ
  workPressure: number; // 1-5åˆ†ï¼Œè¶Šé«˜å‹åŠ›è¶Šå¤§
  teamAtmosphere: number; // 1-5åˆ†
  workInterest: number; // 1-5åˆ†

  // ç”Ÿæ´»å¹³è¡¡
  workFlexibility: number; // 1-5åˆ†
  vacationBenefit: number; // 1-5åˆ†
  workLifeBalance: number; // 1-5åˆ†
}

interface CalculationResult {
  totalScore: number;
  level: string;
  color: string;
  icon: LucideIcon;
  humorLabel: string;
  humorDescription: string;
  dimensions: {
    economic: { score: number; percentage: number };
    time: { score: number; percentage: number };
    growth: { score: number; percentage: number };
    experience: { score: number; percentage: number };
    balance: { score: number; percentage: number };
  };
  hourlyValue: number;
  recommendations: string[];
}

interface DimensionScores {
  economic: number;
  time: number;
  growth: number;
  experience: number;
  balance: number;
  total: number;
}

export default function CalculatorPage() {
  const [formData, setFormData] = useState<FormData>({
    monthlySalary: 0,
    annualBonus: 0,
    benefits: 0,
    weeklyHours: 40,
    commuteHours: 0,
    overtimeFrequency: 3,
    skillGrowth: 3,
    promotionChance: 3,
    industryProspect: 3,
    workPressure: 3,
    teamAtmosphere: 3,
    workInterest: 3,
    workFlexibility: 3,
    vacationBenefit: 3,
    workLifeBalance: 3,
  });
  const [result, setResult] = useState<CalculationResult | null>(null);
  const [isCapturing, setIsCapturing] = useState(false);
  const [captureSuccess, setCaptureSuccess] = useState(false);
  const reportRef = useRef<HTMLDivElement>(null);

  const updateFormData = (field: keyof FormData, value: number) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const calculateScore = (): CalculationResult => { 
    // 1. ç»æµå›æŠ¥ç»´åº¦ (30%)
    const totalAnnualIncome = formData.monthlySalary * 12 + formData.annualBonus + formData.benefits;
    const totalWorkHours = formData.weeklyHours * 52 + formData.commuteHours * 52 * 5;
    const hourlyRate = totalAnnualIncome / totalWorkHours;
    
    // ç»æµå¾—åˆ†åŸºäºå°æ—¶å·¥èµ„å’ŒåŠ ç­æƒ…å†µ
    const economicBase = Math.min((hourlyRate / 100) * 100, 100);
    const overtimePenalty = (5 - formData.overtimeFrequency) * 2;
    const economicScore = (economicBase * 0.8 + overtimePenalty * 0.2) * 0.3;

    // 2. æ—¶é—´æˆæœ¬ç»´åº¦ (25%)
    const weeklyScore = Math.max(0, 100 - (formData.weeklyHours - 40) * 2);
    const commuteScore = Math.max(0, 100 - formData.commuteHours * 10);
    const overtimeScore = ((5 - formData.overtimeFrequency + 1) / 5) * 100;
    const timeScore = (weeklyScore * 0.4 + commuteScore * 0.3 + overtimeScore * 0.3) * 0.25;

    // 3. æˆé•¿ä»·å€¼ç»´åº¦ (20%)
    const growthScore = (
      (formData.skillGrowth / 5) * 40 +
      (formData.promotionChance / 5) * 35 +
      (formData.industryProspect / 5) * 25
    ) * 0.2;

    // 4. å·¥ä½œä½“éªŒç»´åº¦ (15%)
    const experienceScore = (
      ((5 - formData.workPressure + 1) / 5) * 35 +
      (formData.teamAtmosphere / 5) * 35 +
      (formData.workInterest / 5) * 30
    ) * 0.15;

    // 5. ç”Ÿæ´»å¹³è¡¡ç»´åº¦ (10%)
    const balanceScore = (
      (formData.workFlexibility / 5) * 33 +
      (formData.vacationBenefit / 5) * 33 +
      (formData.workLifeBalance / 5) * 34
    ) * 0.1;

    const totalScore = economicScore + timeScore + growthScore + experienceScore + balanceScore;

    // ç”Ÿæˆå»ºè®®
    const recommendations: string[] = [];
    
    if (economicScore < 20) {
      recommendations.push("ç»æµå›æŠ¥åä½ï¼Œå»ºè®®è€ƒè™‘è–ªèµ„è°ˆåˆ¤æˆ–å¯»æ‰¾æ›´å¥½çš„æœºä¼š");
    }
    if (timeScore < 15) {
      recommendations.push("æ—¶é—´æˆæœ¬è¿‡é«˜ï¼Œå»ºè®®ä¼˜åŒ–å·¥ä½œæ—¶é—´æˆ–å‡å°‘é€šå‹¤æ—¶é—´");
    }
    if (growthScore < 12) {
      recommendations.push("æˆé•¿ç©ºé—´æœ‰é™ï¼Œå»ºè®®ä¸»åŠ¨å¯»æ±‚å­¦ä¹ æœºä¼šæˆ–è€ƒè™‘è½¬å‹");
    }
    if (experienceScore < 9) {
      recommendations.push("å·¥ä½œä½“éªŒä¸ä½³ï¼Œå»ºè®®ä¸ç®¡ç†å±‚æ²Ÿé€šæˆ–è€ƒè™‘æ¢ç¯å¢ƒ");
    }
    if (balanceScore < 6) {
      recommendations.push("å·¥ä½œç”Ÿæ´»å¤±è¡¡ï¼Œå»ºè®®è®¾å®šæ˜ç¡®è¾¹ç•Œæˆ–å¯»æ±‚æ›´çµæ´»çš„å·¥ä½œ");
    }

    if (totalScore >= 80) {
      recommendations.push("æ•´ä½“æ€§ä»·æ¯”ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒå¹¶å¯»æ±‚æ›´é«˜å±‚æ¬¡å‘å±•");
    } else if (totalScore >= 60) {
      recommendations.push("æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œå¯é’ˆå¯¹è–„å¼±ç»´åº¦è¿›è¡Œä¼˜åŒ–");
    } else if (totalScore >= 40) {
      recommendations.push("æ€§ä»·æ¯”ä¸­ç­‰ï¼Œå»ºè®®åˆ¶å®šæ”¹è¿›è®¡åˆ’ï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦åšå‡ºæ”¹å˜");
    } else {
      recommendations.push("æ€§ä»·æ¯”è¾ƒä½ï¼Œå¼ºçƒˆå»ºè®®é‡æ–°è¯„ä¼°èŒä¸šé€‰æ‹©ï¼Œå¯»æ±‚æ›´å¥½çš„æœºä¼š");
    }

    let level = "";
    let color = "";
    let icon = Minus;
    let humorLabel = "";
    let humorDescription = "";
    
    if (totalScore >= 90) {
      level = "ä¼˜ç§€";
      color = "text-green-600";
      icon = TrendingUp;
      humorLabel = "ğŸ‰ äººç”Ÿèµ¢å®¶";
      humorDescription = "è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„èººèµ¢æ¨¡å¼";
    } else if (totalScore >= 80) {
      level = "ä¼˜ç§€";
      color = "text-green-600";
      icon = TrendingUp;
      humorLabel = "ğŸ˜ èŒåœºç²¾è‹±";
      humorDescription = "åˆ«äºº996ï¼Œä½ åœ¨äº«å—ç”Ÿæ´»";
    } else if (totalScore >= 70) {
      level = "è‰¯å¥½";
      color = "text-blue-600";
      icon = TrendingUp;
      humorLabel = "ğŸ’¼ ç™½é¢†ä¸€æ—";
      humorDescription = "ä½“é¢å·¥ä½œï¼Œç¨³ä¸­å‘å¥½";
    } else if (totalScore >= 60) {
      level = "è‰¯å¥½";
      color = "text-blue-600";
      icon = TrendingUp;
      humorLabel = "ğŸƒ å¥‹æ–—é’å¹´";
      humorDescription = "æœ‰ç‚¹ç´¯ä½†è¿˜ç®—å€¼å¾—";
    } else if (totalScore >= 50) {
      level = "ä¸­ç­‰";
      color = "text-yellow-600";
      icon = Minus;
      humorLabel = "ğŸ˜… æ‰“å·¥äºº";
      humorDescription = "æ ‡å‡†ç¤¾ç•œï¼Œå‹‰å¼ºç³Šå£";
    } else if (totalScore >= 40) {
      level = "ä¸­ç­‰";
      color = "text-yellow-600";
      icon = Minus;
      humorLabel = "ğŸ˜“ å·¥å…·äºº";
      humorDescription = "ä»˜å‡ºä¸å›æŠ¥ä¸å¤ªåŒ¹é…";
    } else if (totalScore >= 30) {
      level = "å¾…æ”¹å–„";
      color = "text-red-600";
      icon = TrendingDown;
      humorLabel = "ğŸ´ ç°ä»£ç‰›é©¬";
      humorDescription = "å»ºè®®è€ƒè™‘è·³æ§½æ”¹å‘½";
    } else {
      level = "å¾…æ”¹å–„";
      color = "text-red-600";
      icon = TrendingDown;
      humorLabel = "ğŸ’€ è¡€æ±—å·¥å‚";
      humorDescription = "å¿«è·‘ï¼ç•™å¾—é’å±±åœ¨";
    }

    return {
      totalScore: Math.round(totalScore * 10) / 10,
      level,
      color,
      icon,
      humorLabel,
      humorDescription,
      dimensions: {
        economic: { score: Math.round(economicScore * 10) / 10, percentage: 30 },
        time: { score: Math.round(timeScore * 10) / 10, percentage: 25 },
        growth: { score: Math.round(growthScore * 10) / 10, percentage: 20 },
        experience: { score: Math.round(experienceScore * 10) / 10, percentage: 15 },
        balance: { score: Math.round(balanceScore * 10) / 10, percentage: 10 },
      },
      hourlyValue: Math.round(hourlyRate * 10) / 10,
      recommendations,
    };
  };

  const handleSubmit = () => {
    const calculationResult = calculateScore();
    setResult(calculationResult);
  };

  const handleCapture = async () => {
    if (!reportRef.current) return;

    setIsCapturing(true);
    setCaptureSuccess(false);

    try {
      // ç­‰å¾…åŠ¨ç”»æ•ˆæœ
      await new Promise(resolve => setTimeout(resolve, 300));

      const canvas = await html2canvas(reportRef.current, {
        backgroundColor: '#ffffff',
        scale: 2, // æé«˜æ¸…æ™°åº¦
        logging: false,
        useCORS: true,
      });

      // è½¬æ¢ä¸º blob
      canvas.toBlob(async (blob) => {
        if (blob) {
          try {
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            await navigator.clipboard.write([
              new ClipboardItem({
                'image/png': blob
              })
            ]);
            
            setCaptureSuccess(true);
            setTimeout(() => setCaptureSuccess(false), 3000);
          } catch (err) {
            console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', err);
            // é™çº§æ–¹æ¡ˆï¼šä¸‹è½½å›¾ç‰‡
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `å·¥ä½œæ€§ä»·æ¯”æŠ¥å‘Š-${new Date().getTime()}.png`;
            link.href = url;
            link.click();
            
            setCaptureSuccess(true);
            setTimeout(() => setCaptureSuccess(false), 3000);
          }
        }
        setIsCapturing(false);
      }, 'image/png');
    } catch (error) {
      console.error('æˆªå›¾å¤±è´¥:', error);
      setIsCapturing(false);
    }
  };

  const renderStep1 = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ç¬¬ä¸€æ­¥ï¼šç»æµå›æŠ¥</h2>
      <p className="text-muted-foreground">è¯·å¡«å†™ä½ çš„æ”¶å…¥ç›¸å…³ä¿¡æ¯</p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">æœˆè–ªæ”¶å…¥ï¼ˆå…ƒï¼‰</label>
          <input
            type="number"
            value={formData.monthlySalary || ""}
            onChange={(e) => updateFormData("monthlySalary", Number(e.target.value))}
            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
            placeholder="å¦‚ï¼š15000"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å¹´ç»ˆå¥–ï¼ˆå…ƒï¼‰</label>
          <input
            type="number"
            value={formData.annualBonus || ""}
            onChange={(e) => updateFormData("annualBonus", Number(e.target.value))}
            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
            placeholder="å¦‚ï¼š30000"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å…¶ä»–ç¦åˆ©å¹´ä»·å€¼ï¼ˆå…ƒï¼‰</label>
          <input
            type="number"
            value={formData.benefits || ""}
            onChange={(e) => updateFormData("benefits", Number(e.target.value))}
            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
            placeholder="å¦‚ï¼š5000ï¼ˆäº”é™©ä¸€é‡‘ã€è¡¥è´´ç­‰æŠ˜ç®—å¹´ä»·å€¼ï¼‰"
          />
          <p className="text-xs text-muted-foreground mt-1">åŒ…æ‹¬äº”é™©ä¸€é‡‘ã€äº¤é€šè¡¥è´´ã€é¤è¡¥ç­‰</p>
        </div>
      </div>
    </div>
  );

  const renderStep2 = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ç¬¬äºŒæ­¥ï¼šæ—¶é—´æˆæœ¬</h2>
      <p className="text-muted-foreground">è¯„ä¼°ä½ åœ¨å·¥ä½œä¸ŠæŠ•å…¥çš„æ—¶é—´</p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">å‘¨å·¥ä½œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
          <input
            type="number"
            value={formData.weeklyHours || ""}
            onChange={(e) => updateFormData("weeklyHours", Number(e.target.value))}
            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
            placeholder="å¦‚ï¼š40"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">æ¯æ—¥é€šå‹¤æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
          <input
            type="number"
            step="0.5"
            value={formData.commuteHours || ""}
            onChange={(e) => updateFormData("commuteHours", Number(e.target.value))}
            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
            placeholder="å¦‚ï¼š2ï¼ˆå¾€è¿”æ€»æ—¶é•¿ï¼‰"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">åŠ ç­é¢‘ç‡ï¼ˆ1-5åˆ†ï¼Œ5åˆ†ä¸ºç»å¸¸åŠ ç­ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.overtimeFrequency}
            onChange={(e) => updateFormData("overtimeFrequency", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å‡ ä¹ä¸åŠ ç­</span>
            <span className="font-medium text-primary">{formData.overtimeFrequency}</span>
            <span>ç»å¸¸åŠ ç­</span>
          </div>
        </div>
      </div>
    </div>
  );

  const renderStep3 = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ç¬¬ä¸‰æ­¥ï¼šæˆé•¿ä»·å€¼</h2>
      <p className="text-muted-foreground">è¯„ä¼°è¿™ä»½å·¥ä½œå¯¹ä½ èŒä¸šå‘å±•çš„ä»·å€¼</p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">æŠ€èƒ½æå‡æœºä¼šï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.skillGrowth}
            onChange={(e) => updateFormData("skillGrowth", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å¾ˆå°‘å­¦ä¹ </span>
            <span className="font-medium text-primary">{formData.skillGrowth}</span>
            <span>æŒç»­æˆé•¿</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">æ™‹å‡ç©ºé—´ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.promotionChance}
            onChange={(e) => updateFormData("promotionChance", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å¾ˆéš¾æ™‹å‡</span>
            <span className="font-medium text-primary">{formData.promotionChance}</span>
            <span>æœºä¼šå¾ˆå¤š</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">è¡Œä¸šå‰æ™¯ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.industryProspect}
            onChange={(e) => updateFormData("industryProspect", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å‰æ™¯å ªå¿§</span>
            <span className="font-medium text-primary">{formData.industryProspect}</span>
            <span>å‰æ™¯å…‰æ˜</span>
          </div>
        </div>
      </div>
    </div>
  );

  const renderStep4 = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ç¬¬å››æ­¥ï¼šå·¥ä½œä½“éªŒ</h2>
      <p className="text-muted-foreground">è¯„ä¼°ä½ çš„å·¥ä½œæ„Ÿå—å’Œç¯å¢ƒ</p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">å·¥ä½œå‹åŠ›ï¼ˆ1-5åˆ†ï¼Œ5åˆ†ä¸ºå‹åŠ›å¾ˆå¤§ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.workPressure}
            onChange={(e) => updateFormData("workPressure", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å‹åŠ›å¾ˆå°</span>
            <span className="font-medium text-primary">{formData.workPressure}</span>
            <span>å‹åŠ›å¾ˆå¤§</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å›¢é˜Ÿæ°›å›´ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.teamAtmosphere}
            onChange={(e) => updateFormData("teamAtmosphere", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>æ°›å›´è¾ƒå·®</span>
            <span className="font-medium text-primary">{formData.teamAtmosphere}</span>
            <span>æ°›å›´å¾ˆå¥½</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å·¥ä½œå…´è¶£åº¦ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.workInterest}
            onChange={(e) => updateFormData("workInterest", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>ä¸æ„Ÿå…´è¶£</span>
            <span className="font-medium text-primary">{formData.workInterest}</span>
            <span>éå¸¸å–œæ¬¢</span>
          </div>
        </div>
      </div>
    </div>
  );

  const renderStep5 = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ç¬¬äº”æ­¥ï¼šç”Ÿæ´»å¹³è¡¡</h2>
      <p className="text-muted-foreground">è¯„ä¼°å·¥ä½œä¸ç”Ÿæ´»çš„å¹³è¡¡çŠ¶å†µ</p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">å·¥ä½œçµæ´»åº¦ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.workFlexibility}
            onChange={(e) => updateFormData("workFlexibility", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å¾ˆä¸çµæ´»</span>
            <span className="font-medium text-primary">{formData.workFlexibility}</span>
            <span>éå¸¸çµæ´»</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å‡æœŸç¦åˆ©ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.vacationBenefit}
            onChange={(e) => updateFormData("vacationBenefit", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>å‡æœŸå¾ˆå°‘</span>
            <span className="font-medium text-primary">{formData.vacationBenefit}</span>
            <span>å‡æœŸå……è¶³</span>
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">å·¥ä½œç”Ÿæ´»å¹³è¡¡ï¼ˆ1-5åˆ†ï¼‰</label>
          <input
            type="range"
            min="1"
            max="5"
            value={formData.workLifeBalance}
            onChange={(e) => updateFormData("workLifeBalance", Number(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-muted-foreground">
            <span>ä¸¥é‡å¤±è¡¡</span>
            <span className="font-medium text-primary">{formData.workLifeBalance}</span>
            <span>å¹³è¡¡è‰¯å¥½</span>
          </div>
        </div>
      </div>
    </div>
  );

  const renderResult = () => {
    if (!result) return null;
    
    const Icon = result.icon;
    
    return (
      <div className="space-y-8">
        {/* æˆªå›¾æŒ‰é’® */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="flex justify-end"
        >
          <Button
            onClick={handleCapture}
            disabled={isCapturing}
            variant="outline"
            className="gap-2"
          >
            {captureSuccess ? (
              <>
                <Check className="h-4 w-4 text-green-600" />
                å·²ä¿å­˜åˆ°å‰ªè´´æ¿
              </>
            ) : (
              <>
                <Camera className="h-4 w-4" />
                {isCapturing ? 'æˆªå›¾ä¸­...' : 'ä¿å­˜ä¸ºå›¾ç‰‡'}
              </>
            )}
          </Button>
        </motion.div>

        {/* æŠ¥å‘Šå†…å®¹åŒºåŸŸ */}
        <div ref={reportRef} className="space-y-8 bg-background p-8 rounded-xl">
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ duration: 0.5 }}
          className="text-center"
        >
          <h2 className="text-3xl font-bold mb-4">ä½ çš„å·¥ä½œæ€§ä»·æ¯”è¯„ä¼°æŠ¥å‘Š</h2>
          <div className="inline-flex items-center gap-3 bg-card border rounded-xl p-6">
            <Icon className={`h-12 w-12 ${result.color}`} />
            <div className="text-left">
              <div className="text-sm text-muted-foreground">ç»¼åˆå¾—åˆ†</div>
              <div className="text-4xl font-bold">{result.totalScore}</div>
              <div className={`text-lg font-semibold ${result.color}`}>{result.level}</div>
            </div>
          </div>
          
          {/* å¹½é»˜è¯„ä»· */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5, delay: 0.2 }}
            className="mt-6 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 border border-purple-200 dark:border-purple-800 rounded-xl p-6"
          >
            <div className="text-2xl font-bold mb-2">{result.humorLabel}</div>
            <div className="text-muted-foreground">{result.humorDescription}</div>
          </motion.div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5, delay: 0.3 }}
          className="bg-card border rounded-xl p-6"
        >
          <h3 className="text-xl font-bold mb-4">å„ç»´åº¦å¾—åˆ†</h3>
          <div className="space-y-4">
            {[
              { key: "economic", label: "ç»æµå›æŠ¥", icon: "ğŸ’°" },
              { key: "time", label: "æ—¶é—´æˆæœ¬", icon: "â°" },
              { key: "growth", label: "æˆé•¿ä»·å€¼", icon: "ğŸ“ˆ" },
              { key: "experience", label: "å·¥ä½œä½“éªŒ", icon: "ğŸ˜Š" },
              { key: "balance", label: "ç”Ÿæ´»å¹³è¡¡", icon: "âš–ï¸" },
            ].map(({ key, label, icon }) => {
              const dim = result.dimensions[key as keyof typeof result.dimensions];
              const maxScore = dim.percentage;
              const percentage = (dim.score / maxScore) * 100;
              
              return (
                <div key={key}>
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-medium">{icon} {label}</span>
                    <span className="text-sm text-muted-foreground">
                      {dim.score.toFixed(1)} / {maxScore}
                    </span>
                  </div>
                  <div className="w-full bg-muted rounded-full h-3">
                    <div
                      className="bg-primary rounded-full h-3 transition-all"
                      style={{ width: `${percentage}%` }}
                    />
                  </div>
                </div>
              );  
            })}
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5, delay: 0.4 }}
          className="bg-card border rounded-xl p-6"
        >
          <h3 className="text-xl font-bold mb-4">å…³é”®æŒ‡æ ‡</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-muted/50 rounded-lg p-4">
              <div className="text-sm text-muted-foreground mb-1">æ—¶è–ªä»·å€¼</div>
              <div className="text-2xl font-bold">Â¥{result.hourlyValue.toFixed(2)}</div>
            </div>
            <div className="bg-muted/50 rounded-lg p-4">
              <div className="text-sm text-muted-foreground mb-1">å¹´å·¥ä½œæ€»æ—¶é•¿</div>
              <div className="text-2xl font-bold">
                {((formData.weeklyHours + formData.commuteHours * 5) * 52).toFixed(0)}å°æ—¶
              </div>
            </div>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.5 }}
          className="bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-xl p-6"
        >
          <div className="flex items-start gap-3">
            <Info className="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0" />
            <div>
              <h3 className="text-lg font-bold mb-3 text-blue-900 dark:text-blue-100">æ”¹è¿›å»ºè®®</h3>
              <ul className="space-y-2">
                {result.recommendations.map((rec, index) => (
                  <li key={index} className="text-sm text-blue-800 dark:text-blue-200">
                    â€¢ {rec}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </motion.div>
        </div>

        {/* æ“ä½œæŒ‰é’® */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5, delay: 0.6 }}
          className="flex gap-4"
        >
          <Button onClick={() => { setResult(null); setStep(1); }} className="flex-1">
            é‡æ–°è®¡ç®—
          </Button>
          <Button variant="outline" asChild className="flex-1">
            <Link href="/landing">è¿”å›é¦–é¡µ</Link>
          </Button>
        </motion.div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-background to-muted">
      <div className="container mx-auto px-4 py-8">
        <div className="mb-8">
          <Button variant="ghost" asChild>
            <Link href="/landing">
              <ArrowLeft className="h-4 w-4 mr-2" />
              è¿”å›é¦–é¡µ
            </Link>
          </Button>
        </div>

        <div className="max-w-3xl mx-auto">
          {!result ? (
            <div className="bg-card border rounded-xl p-8 shadow-lg">
              {/* è¿›åº¦æŒ‡ç¤ºå™¨ */}
              <div className="mb-8">
                <div className="flex justify-between mb-2">
                  {[1, 2, 3, 4, 5].map((s) => (
                    <div
                      key={s}
                      className={`flex items-center justify-center w-10 h-10 rounded-full font-semibold ${
                        s === step
                          ? "bg-primary text-primary-foreground"
                          : s < step
                          ? "bg-primary/20 text-primary"
                          : "bg-muted text-muted-foreground"
                      }`}
                    >
                      {s}
                    </div>
                  ))}
                </div>
                <div className="w-full bg-muted rounded-full h-2">
                  <div
                    className="bg-primary rounded-full h-2 transition-all"
                    style={{ width: `${(step / 5) * 100}%` }}
                  />
                </div>
              </div>

              {/* æ­¥éª¤å†…å®¹ */}
              {step === 1 && renderStep1()}
              {step === 2 && renderStep2()}
              {step === 3 && renderStep3()}
              {step === 4 && renderStep4()}
              {step === 5 && renderStep5()}

              {/* å¯¼èˆªæŒ‰é’® */}
              <div className="flex gap-4 mt-8">
                {step > 1 && (
                  <Button variant="outline" onClick={() => setStep(step - 1)} className="flex-1">
                    ä¸Šä¸€æ­¥
                  </Button>
                )}
                {step < 5 ? (
                  <Button onClick={() => setStep(step + 1)} className="flex-1">
                    ä¸‹ä¸€æ­¥
                  </Button>
                ) : (
                  <Button onClick={handleSubmit} className="flex-1">
                    æŸ¥çœ‹ç»“æœ
                  </Button>
                )}
              </div>
            </div>
          ) : (
            <div className="bg-card border rounded-xl p-8 shadow-lg">
              {renderResult()}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
